<html>                                                                  
<head>                                                                  
<script type="text/javascript" src="/js/jquery.js"></script>
<script src="http://maps.google.com/maps/api/js?v=3&amp;sensor=false"></script>
<script type="text/javascript"> 
$(document).ready(function() {
   // $("a").click(function() {
   var access_token = window.location.hash.split('=')[1];
   if (access_token) {
      createCookie('access_token', access_token, 1000);
   }
   console.debug('Your access_token is ' + readCookie('access_token'));
   access_token = readCookie('access_token');
   var url = 'https://api.foursquare.com/v2/users/self/checkins?oauth_token=' + access_token;
   $.ajax({
      url: url, 
      dataType: 'json',
      success: function (data, textStatus, jqXHR) {
         console.debug('success! ' + textStatus + ' ' + data.response.checkins.count);
         map_points(data.response.checkins.items);
      }
   });
 

function map_points(items) {
   var myOptions = {
      center: new google.maps.LatLng(41.25917,-96.06),
      zoom: 11,
      mapTypeId: google.maps.MapTypeId.ROADMAP
   };
   var map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
   var infowindow = new google.maps.InfoWindow();
   var markers = new Array();

   for (var i in items) {
      (function(){
         var createdat =  items[i].createdAt;
         var name =       items[i].venue.name;
         var url =        items[i].venue.url;
         var lat =        items[i].venue.location.lat;
         var lng =        items[i].venue.location.lng;
         var address =    items[i].venue.location.address;
         var city =       items[i].venue.location.city;
         var state =      items[i].venue.location.state;
         var postalcode = items[i].venue.location.postalCode;
         var country =    items[i].venue.location.country;
         console.debug(name + ' ' + lat + ' ' + lng);

         var created = new Date(createdat * 1000);
         var marker = new google.maps.Marker({
            position: new google.maps.LatLng(lat, lng),
            title:    name,
            map:      map,
            icon:     "/images/marker_sprite.png"
         });
         google.maps.event.addListener(marker, 'click', function () {
            infowindow.setContent(
               '<a href="' + url + '">' + name + '</a><br/>' + 
               created.toDateString() + '<br/>' + 
               address + '<br/>' + city + ', ' + state + ' ' + postalcode + ' ' + country
            );
            infowindow.open(map, marker);
         });
      })();
   }
}


// http://www.quirksmode.org/js/cookies.html
function createCookie(name,value,days) {
	if (days) {
		var date = new Date();
		date.setTime(date.getTime()+(days*24*60*60*1000));
		var expires = "; expires="+date.toGMTString();
	}
	else var expires = "";
	document.cookie = name+"="+value+expires+"; path=/";
}

function readCookie(name) {
	var nameEQ = name + "=";
	var ca = document.cookie.split(';');
	for(var i=0;i < ca.length;i++) {
		var c = ca[i];
		while (c.charAt(0)==' ') c = c.substring(1,c.length);
		if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
	}
	return null;
}

function eraseCookie(name) {
	createCookie(name,"",-1);
}

});
</script>                                                               
</head>                                                                 
<body>
   <a href="https://foursquare.com/oauth2/authenticate?client_id=MFHWM4ODQS5CMN5FQLP5JKTBYXLC50EZCUCL5Y3XBVQRFCIQ&response_type=token&redirect_uri=http://www.safeomaha.org/foursquare/oauth2.html">Link your Foursquare</a>

<div id="map_canvas" style="width:1000px;height:400px;"></div>

</body>                                                                 
</html>

